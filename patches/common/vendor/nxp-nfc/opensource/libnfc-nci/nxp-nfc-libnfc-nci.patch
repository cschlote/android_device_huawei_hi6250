From e012f08553b208085ff494cfbf123d2c07686773 Mon Sep 17 00:00:00 2001
From: Carsten Schlote <schlote@vahanus.net>
Date: Sun, 29 Jan 2017 18:50:38 +0100
Subject: [PATCH] Fix NFC

Change-Id: I7b6fcf9f59cf7920a015c6af20456adc6c82f214
---
 Android.mk                                 | 2 +-
 halimpl/pn54x/inc/phNxpNciHal_Adaptation.h | 2 +-
 src/adaptation/NfcAdaptation.cpp           | 7 +++++--
 src/include/nfc_target.h                   | 3 ++-
 src/nfc/nfc/nfc_main.c                     | 2 +-
 src/nfc/nfc/nfc_ncif.c                     | 7 +++++--
 src/nfc/nfc/nfc_task.c                     | 2 ++
 7 files changed, 17 insertions(+), 8 deletions(-)

diff --git a/Android.mk b/Android.mk
index 1fa8506..957e4ea 100644
--- a/Android.mk
+++ b/Android.mk
@@ -46,7 +46,7 @@ LOCAL_CFLAGS += -DJCOP_VER_3_1=$(JCOP_VER_3_1)
 LOCAL_CFLAGS += -DJCOP_VER_3_2=$(JCOP_VER_3_2)
 LOCAL_CFLAGS += -DJCOP_VER_3_3=$(JCOP_VER_3_3)
 
-NFC_NXP_ESE:= TRUE
+NFC_NXP_ESE:= FALSE
 ifeq ($(NFC_NXP_ESE),TRUE)
 LOCAL_CFLAGS += -DNFC_NXP_ESE=TRUE
 LOCAL_CFLAGS += -DNFC_NXP_ESE_VER=$(JCOP_VER_3_3)
diff --git a/halimpl/pn54x/inc/phNxpNciHal_Adaptation.h b/halimpl/pn54x/inc/phNxpNciHal_Adaptation.h
index 07692ae..87fe000 100644
--- a/halimpl/pn54x/inc/phNxpNciHal_Adaptation.h
+++ b/halimpl/pn54x/inc/phNxpNciHal_Adaptation.h
@@ -34,7 +34,7 @@ typedef struct
     struct nfc_nci_device nci_device;
 
     /* Local definitions */
-    int (*ioctl)(const struct nfc_nci_device *p_dev, long arg, void *p_data);
+    int (*ioctl)(const struct nfc_nci_device *p_dev, void *p_data, long arg);
 
 } pn547_dev_t;
 
diff --git a/src/adaptation/NfcAdaptation.cpp b/src/adaptation/NfcAdaptation.cpp
index a770c55..7580651 100644
--- a/src/adaptation/NfcAdaptation.cpp
+++ b/src/adaptation/NfcAdaptation.cpp
@@ -379,7 +379,9 @@ void NfcAdaptation::InitializeHalDeviceContext ()
     mHalEntryFuncs.core_initialized = HalCoreInitialized;
     mHalEntryFuncs.write = HalWrite;
 #if(NXP_EXTNS == TRUE)
+    ALOGD ("mHalEntryFuncs.ioctl = HalIoctl;1");
     mHalEntryFuncs.ioctl = HalIoctl;
+    ALOGD ("mHalEntryFuncs.ioctl = HalIoctl;2");
 #endif
     mHalEntryFuncs.prediscover = HalPrediscover;
     mHalEntryFuncs.control_granted = HalControlGranted;
@@ -528,7 +530,7 @@ typedef struct {
     struct nfc_nci_device nci_device;
 
     /* Local definitions */
-    int(*ioctl)(const struct nfc_nci_device *p_dev, long arg, void *p_data);
+    int(*ioctl)(const struct nfc_nci_device *p_dev, void *p_data, long arg);
 } pn547_dev_t;
 /*******************************************************************************
 **
@@ -552,7 +554,8 @@ int NfcAdaptation::HalIoctl (long arg, void* p_data)
     if (mHalDeviceContext)
     {
         pn547_dev_t *dev = (pn547_dev_t*)mHalDeviceContext;
-        return (dev->ioctl (mHalDeviceContext, arg, p_data));
+        ALOGD ("pn547_dev_t *dev = (pn547_dev_t*)mHalDeviceContext;");
+        return (dev->ioctl (mHalDeviceContext, p_data, arg));
     }
     return -1;
 }
diff --git a/src/include/nfc_target.h b/src/include/nfc_target.h
index d292d01..feef57c 100644
--- a/src/include/nfc_target.h
+++ b/src/include/nfc_target.h
@@ -184,9 +184,10 @@
 
 #define NCI_VERSION_0_F             0x0F
 #define NCI_VERSION_1_0             0x10
+#define NCI_VERSION_1_1             0x11
 
 #ifndef NCI_VERSION
-#define NCI_VERSION                 NCI_VERSION_1_0
+#define NCI_VERSION                 NCI_VERSION_1_1
 #endif
 
 /* TRUE I2C patch is needed */
diff --git a/src/nfc/nfc/nfc_main.c b/src/nfc/nfc/nfc_main.c
index 0f3aaba..7b1808b 100644
--- a/src/nfc/nfc/nfc_main.c
+++ b/src/nfc/nfc/nfc_main.c
@@ -455,7 +455,7 @@ void nfc_main_handle_hal_evt (tNFC_HAL_EVT_MSG *p_msg)
                 if (p_msg->status == HAL_NFC_STATUS_OK)
                 {
                     nfc_enabled (NCI_STATUS_OK, nfc_cb.p_nci_init_rsp);
-#if(NXP_EXTNS == TRUE)
+#if(NXP_EXTNS == FALSE)
                     /*
                      * reading requred EEPROM config vlaues from HAL
                      * and updating libnfc structure.
diff --git a/src/nfc/nfc/nfc_ncif.c b/src/nfc/nfc/nfc_ncif.c
index df89471..80d58b4 100644
--- a/src/nfc/nfc/nfc_ncif.c
+++ b/src/nfc/nfc/nfc_ncif.c
@@ -1961,6 +1961,7 @@ UINT8 nfc_hal_nfcc_init(UINT8 **pinit_rsp)
 *******************************************************************************/
 void nfc_ncif_proc_init_rsp (BT_HDR *p_msg)
 {
+    NFC_TRACE_DEBUG0("nfc_ncif_proc_init_rsp");
     UINT8 *p, status;
     tNFC_CONN_CB * p_cb = &nfc_cb.conn_cb[NFC_RF_CONN_ID];
 #if (NXP_EXTNS == TRUE)
@@ -2045,7 +2046,7 @@ void nfc_ncif_proc_init_rsp (BT_HDR *p_msg)
 #endif
         p_cb->id            = NFC_RF_CONN_ID;
         p_cb->act_protocol  = NCI_PROTOCOL_UNKNOWN;
-#if(NXP_EXTNS == TRUE)
+#if(NXP_EXTNS == FALSE)
         retry_cnt = 0;
 #endif
         nfc_set_state (NFC_STATE_W4_POST_INIT_CPLT);
@@ -2064,16 +2065,18 @@ void nfc_ncif_proc_init_rsp (BT_HDR *p_msg)
             fw_status != NCI_STATUS_OK &&
             NCI_STATUS_OK == fw_mw_ver_status)
     {
+        NFC_TRACE_DEBUG0("GKI_FREEBUF1");
         GKI_send_event (NFC_TASK, NFC_TASK_EVT_TRANSPORT_READY);
         GKI_freebuf (p_msg);
     }
 #endif
     else
     {
-#if(NXP_EXTNS == TRUE)
+#if(NXP_EXTNS == FALSE)
         status = NCI_STATUS_FAILED;
         retry_cnt = 0;
 #endif
+        NFC_TRACE_DEBUG0("GKI_FREEBUF2");
         nfc_enabled (status, NULL);
         GKI_freebuf (p_msg);
     }
diff --git a/src/nfc/nfc/nfc_task.c b/src/nfc/nfc/nfc_task.c
index 80c3aa5..8e0c30e 100644
--- a/src/nfc/nfc/nfc_task.c
+++ b/src/nfc/nfc/nfc_task.c
@@ -158,7 +158,9 @@ void nfc_process_timer_evt (void)
                 nfc_cb.i2c_data_t.nci_cmd_channel_busy = 0;
                 nfc_cb.i2c_data_t.data_stored = 0;
             }
+            #if(NFC_NXP_ESE == TRUE)
             nfc_ncif_credit_ntf_timeout();
+            #endif
 #endif
             break;
         }
-- 
2.11.0

